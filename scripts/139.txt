#include"npccommands.h"
#include"summoning.h"
#include"dir.h"
void main()
{
	int id=getPlayer();
	cPlayer *player=playerStruct(id);
	if(player->worth>0)
	{
		player->worth=0;
	}
	int masterid=player->target_at;
	if(masterid>-1)
	{
		cPlayer *master=playerStruct(masterid);
		
		player->serenity=master->serenity;
		
		char command[256];
		
		sprintf(command,"summonatk %s %d",player->name,id);
		if(isGlobal(command))
		{
			runScript(globalInt(command),0);
			npcNoAtk(id);
		}
		
		sprintf(command,"summoncmd %s %d",player->name,id);
		if(isGlobal(command))
		{
			switch(globalInt(command))
			{
				case ATTACK:
					if(getMTarget(masterid)!=-1)
					{
						cPlayer *target=playerStruct(getMTarget(masterid));
						if(target->type==PLAYER_TYPE_NPC&&target->target_at==-1)
						{
							target->serenity=0;
						}
						if(target->serenity<=0)
						{
							player->target=getMTarget(masterid);
						}
						else
						{
							freeGlobal(command);
							sendMapChatf(player->map,"%s:%s has serenity.. I cannot kill them. As much as I want to...",player->name,target->name);
						}
					}
					break;
				case RETURN:
					player->target=-1;
					break;
				case RELEASE:
					unSummon(id);
					break;
			}
		}
		if(player->target>-1)
		{
			int target=player->target;
			cPlayer *victim=playerStruct(target);
			if(victim->total_time>0 && victim->type == PLAYER_TYPE_NPC)
			{
				player->target=-1;
			}
			else if((victim->serenity==0&&master->serenity==0)||victim->type==PLAYER_TYPE_NPC)
			{
				if(distance(id,target)<5)
				{
					if(!npc_attack(id,target))
					{
						npc_follow(id,target,true);
					}
					else if(victim->hp<=0)
					{
						player->target=-1;
					}
					victim->target=id;
				}
				else
				{
					chargeTo(id,target);
				}
			}
			else
			{
				player->target=-1;
				freeGlobal(command);
			}
		}
		else
		{
			cMap *map=mapStruct(player->map);
			if(master->map==player->map||master->map==map->w||master->map==map->s||master->map==map->n||master->map==map->e)
			{
				if(distance(id,masterid)>4)
				{
					chargeTo(id,masterid);
				}
				else if(distance(id,masterid)>1)
				{
					
					npc_follow(id,masterid,true);
				}
				else
				{
					player->dir=master->dir;
				}
			}
			else
			{
				int x=master->x;
				int y=master->y;
				switch(master->dir)
				{
					case DIR_UP:
						y++;
						break;
					case DIR_DOWN:
						y--;
						break;
					case DIR_LEFT:
						x++;
						break;
					case DIR_RIGHT:
						x--;
						break;
				}
				if(inBounds(x,y)&&pass(getTileType(master->map,x,y)))
				{
					npc_warp(id,master->map,x,y);
				}
			}
		}
	}
	else
	{
		player->move_script=-1;
	}
	runScript(140,300);
}